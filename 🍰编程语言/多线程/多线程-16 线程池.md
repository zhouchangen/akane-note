# å¤šçº¿ç¨‹ - çº¿ç¨‹æ± 



## ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± 

ä½¿ç”¨çº¿ç¨‹æ± ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªåŸå› ï¼š

1. åˆ›å»º/é”€æ¯çº¿ç¨‹éœ€è¦æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œçº¿ç¨‹æ± å¯ä»¥**å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹**ã€‚
2. **æ§åˆ¶å¹¶å‘çš„æ•°é‡**ã€‚å¹¶å‘æ•°é‡è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºæ¶ˆè€—è¿‡å¤šï¼Œä»è€Œé€ æˆæœåŠ¡å™¨å´©æºƒã€‚ï¼ˆä¸»è¦åŸå› ï¼‰
3. **å¯ä»¥å¯¹çº¿ç¨‹åšç»Ÿä¸€ç®¡ç†**ã€‚



## çº¿ç¨‹æ± åˆ†ç±»

- ThreadPoolExecutor
- ForkJoinPool



## Executoræ¶æ„ä½“ç³»

Javaä¸­çš„çº¿ç¨‹æ± é¡¶å±‚æ¥å£æ˜¯Executoræ¥å£ï¼ŒExecutoræä¾›äº†çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•execute()ï¼ŒExecutorServiceæä¾›äº†çº¿ç¨‹ä¸­æ–­æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜æä¾›äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œçš„æ–¹æ³•submit()ã€‚ThreadPoolExecutoræ˜¯å…¶åŸºæœ¬å®ç°

ExecutorService

â€‹		AbstractExecutorService (java.util.concurrent)
â€‹				ThreadPoolExecutor (java.util.concurrent)
â€‹				ForkJoinPool (java.util.concurrent)



### execute()å’Œsubmit()åŒºåˆ«

Executoræä¾›åŸºæœ¬çš„æ‰§è¡Œæ–¹æ³•æ˜¯executeï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ”¹æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ã€‚å› æ­¤åœ¨ExecutorServiceä¸­åˆæä¾›äº†å¸¦è¿”å›å€¼çš„çº¿ç¨‹æ‰§è¡Œæ–¹æ³•submit

```java
public interface Executor {

    /**
     * Executes the given command at some time in the future.  The command
     * may execute in a new thread, in a pooled thread, or in the calling
     * thread, at the discretion of the {@code Executor} implementation.
     *
     * @param command the runnable task
     * @throws RejectedExecutionException if this task cannot be
     * accepted for execution
     * @throws NullPointerException if command is null
     */
    void execute(Runnable command);
}


// -----------------------------------------------------------------------------------------
public interface ExecutorService extends Executor {
    Future<?> submit(Runnable task);
```



**åŒºåˆ«ï¼š**

- execute() ï¼šæäº¤æ— è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡åœ¨çº¿ç¨‹æ± ä¸­æ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚
- submit() ï¼šå¼‚æ­¥æäº¤ï¼Œçº¿ç¨‹æ± ä¼šè¿”å›â¼€ä¸ª Future ç±»å‹çš„å¯¹è±¡ã€‚**è°ƒç”¨Futureçš„get()æ–¹æ³•ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆ**ã€‚ä¹Ÿå¯ä»¥è°ƒç”¨ getï¼ˆlong timeoutï¼Œ TimeUnit unitï¼‰ è®¾ç½®é˜»å¡çš„æ—¶é•¿ã€‚



å› æ­¤ï¼Œä½¿ç”¨çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„å¯¹è±¡å¼•ç”¨ä¸è¦ç”¨çº¿ç¨‹æ± é¡¶çº§æ¥å£Executorï¼Œå¦åˆ™æ— æ³•è°ƒç”¨submit()æ–¹æ³•

```java
public static void main(String[] args) {
    ThreadPoolExecutor pool1 = new ThreadPoolExecutor(
            5,
            10,
            10L,
            TimeUnit.MINUTES,
            new LinkedBlockingDeque<>(50),
            Executors.defaultThreadFactory(),
            new ThreadPoolExecutor.AbortPolicy()
    );

    // pool1.submit();
    // pool1.execute();

    Executor pool2 = new ThreadPoolExecutor(
            5,
            10,
            10L,
            TimeUnit.MINUTES,
            new LinkedBlockingDeque<>(50),
            Executors.defaultThreadFactory(),
            new ThreadPoolExecutor.AbortPolicy()
    );
    // pool2æ— submitï¼Œå› ä¸ºå¯¹è±¡å¼•ç”¨æ˜¯çº¿ç¨‹æ± é¡¶çº§æ¥å£Executor
    // pool1.execute();
}
```



### Future

Futureï¼šæœªæ¥çš„æ„æ€

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Runnableå’ŒThreadæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œä½†æ˜¯é—®é¢˜æ˜¯æ²¡æœ‰è¿”å›å€¼ã€‚

å› ä¸ºåœ¨jDK1.5æä¾›äº†Callableï¼Œé‚£è¿™ä¸ªå€¼æ€ä¹ˆæ‹¿ï¼Ÿå°±æ˜¯é€šè¿‡Futureå»è·å–ï¼Œè€ŒFutureTaskæ˜¯å…¶å®ç°ç±»ï¼ŒFutureTaskæ—¢æ˜¯ä¸€ä¸ªFutureï¼Œä¹Ÿæ˜¯ä¸€ä¸ªTaskã€‚

æ³¨ï¼šCompletableFutureæ˜¯æ›´é«˜çº§çš„Futureï¼Œæä¾›äº†æ›´å¤šç‰¹æ€§ã€‚

**å…³é”®å­—ï¼šFutureã€FutureTaskã€CompletableFuture**



## ThreadPoolExecutor

æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹çº¿ç¨‹æ± çš„åŸºæœ¬å®ç°ç±»ï¼ŒThreadPoolExecutorï¼Œä¸€å…±æä¾›äº†7ä¸ªå‚æ•°ã€‚

```java
ThreadPoolExecutor pool = new ThreadPoolExecutor(
        5,
        10,
        10L,
        TimeUnit.MINUTES,
        new LinkedBlockingDeque<>(50),
        Executors.defaultThreadFactory(),
        new ThreadPoolExecutor.AbortPolicy()
);
```



## çº¿ç¨‹æ± å‚æ•°

é‡è¦çš„å‚æ•°ï¼é‡è¦çš„å‚æ•°ï¼é‡è¦çš„å‚æ•°ï¼



### corePoolSize

corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°



**ä»€ä¹ˆæ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°è§£é‡Š**

çº¿ç¨‹æ± ä¸­æœ‰ä¸¤ç±»çº¿ç¨‹ï¼Œæ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹ã€‚

- æ ¸å¿ƒçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹ä¼š**ä¸€ç›´å­˜åœ¨**äºçº¿ç¨‹æ± ä¸­ï¼Œå³ä½¿è¿™ä¸ªæ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆéƒ½ä¸å¹²ï¼ˆé“é¥­ç¢—ï¼‰
- è€Œéæ ¸å¿ƒçº¿ç¨‹å¦‚æœé•¿æ—¶é—´çš„é—²ç½®ï¼Œå°±ä¼šè¢«é”€æ¯ï¼ˆä¸´æ—¶å·¥ï¼‰ã€‚



### maximumPoolSize

maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°

æœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° + éæ ¸å¿ƒçº¿ç¨‹æ•°

æ³¨ï¼šå½“ä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹æ•°å»æ‰§è¡Œã€‚å½“çº¿ç¨‹æ± æ»¡æ—¶ï¼Œä¼šé‡‡ç”¨æ‹’ç»ç­–ç•¥ã€‚



### keepAliveTime

keepAliveTimeï¼šéæ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é•¿

éæ ¸å¿ƒçº¿ç¨‹å¦‚æœå¤„äºé—²ç½®çŠ¶æ€è¶…è¿‡è¯¥å€¼ï¼Œå°±ä¼šè¢«é”€æ¯ã€‚å¦‚æœè®¾ç½®allowCoreThreadTimeOut(true)ï¼Œåˆ™ä¹Ÿä¼šä½œç”¨äºæ ¸å¿ƒçº¿ç¨‹ã€‚

keepAliveTime = 0 åˆ™éæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åç›´æ¥é”€æ¯ç»“æŸï¼Œä¸å­˜æ´»ã€‚



### TimeUnit

unitï¼škeepAliveTimeçš„å•ä½

ä¾‹å¦‚ï¼šTimeUnit.MINUTES åˆ†



### BlockingQueue

BlockingQueueï¼šä»»åŠ¡é˜Ÿåˆ—

å½“**çº¿ç¨‹**æ•°æ»¡äº†ï¼Œæ²¡æœ‰ç©ºä½™çš„çº¿ç¨‹æ‰§è¡Œ**ä»»åŠ¡**æ—¶ï¼Œä»»åŠ¡å°±è¿›å…¥äº†ç­‰å¾…é˜Ÿåˆ—ï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰ã€‚BlockingQueueä¸€èˆ¬ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

æ³¨ï¼šè¿™é‡Œæœ‰ä¸ªçº¿ç¨‹å’Œä»»åŠ¡çš„æ¦‚å¿µã€‚é˜»å¡é˜Ÿåˆ—çš„æ¦‚å¿µè§ã€å¤šçº¿ç¨‹ -å¹¶å‘å®¹å™¨ã€‘ä¸€ç« 



å››ç§é˜»å¡é˜Ÿåˆ—ï¼š

1. LinkedBlockingQueueï¼šé“¾å¼é˜»å¡é˜Ÿåˆ—ï¼Œåº•å±‚æ•°æ®ç»“æ„æ˜¯**é“¾è¡¨**ï¼Œé»˜è®¤å¤§å°æ˜¯**Integer.MAX_VALUE**ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå¤§å°ã€‚

2. ArrayBlockingQueueï¼šæ•°ç»„é˜»å¡é˜Ÿåˆ—ï¼Œåº•å±‚æ•°æ®ç»“æ„æ˜¯**æ•°ç»„**ï¼Œéœ€è¦æŒ‡å®šé˜Ÿåˆ—çš„å¤§å°ã€‚

3. SynchronousQueueï¼šåŒæ­¥é˜Ÿåˆ—ï¼Œå†…éƒ¨å®¹é‡**ä¸º0**ï¼Œputéœ€ç­‰å¾…takeï¼Œtakeéœ€ç­‰å¾…putã€‚

4. DelayQueueï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼ŒæŒ‰ç…§å»¶è¿Ÿæ—¶é—´å…¥é˜Ÿï¼Œ**å»¶è¿Ÿæ—¶é—´åˆ°äº†æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–åˆ°è¯¥å…ƒç´ **ã€‚



### ThreadFactory

ThreadFactoryï¼šçº¿ç¨‹å·¥ç¨‹

åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ ï¼ŒThreadFactoryæä¾›äº†ä¸€ä¸ªæ¥å£newThreadã€‚æ„å‘³ç€ï¼Œå¯ä»¥åœ¨åˆ›å»ºçº¿ç¨‹æ—¶ç»Ÿä¸€è®¾ç½®ä¸€äº›å‚æ•°ã€‚

æ³¨ï¼šé»˜è®¤çš„çº¿ç¨‹å·¥å‚æ˜¯åœ¨Executorsç±»ä¸­ï¼ŒExecutors.defaultThreadFactory()ã€‚å‰é¢æˆ‘ä»¬æåˆ°äº†Executorï¼Œä¸¤è€…å‘½åæœ‰äº›ç›¸è¿‘ï¼Œåé¢ä¼šè®¨è®ºã€‚

```java

public interface ThreadFactory {

    /**
     * Constructs a new {@code Thread}.  Implementations may also initialize
     * priority, name, daemon status, {@code ThreadGroup}, etc.
     *
     * @param r a runnable to be executed by new thread instance
     * @return constructed thread, or {@code null} if the request to
     *         create a thread is rejected
     */
    Thread newThread(Runnable r);
}

// ---------------------------------------------------------------------------------------------------------------------------
static class DefaultThreadFactory implements ThreadFactory {
    private static final AtomicInteger poolNumber = new AtomicInteger(1);
    private final ThreadGroup group;
    private final AtomicInteger threadNumber = new AtomicInteger(1);
    private final String namePrefix;

    DefaultThreadFactory() {
        SecurityManager s = System.getSecurityManager();
        group = (s != null) ? s.getThreadGroup() :
                              Thread.currentThread().getThreadGroup();
        namePrefix = "pool-" +
                      poolNumber.getAndIncrement() +
                     "-thread-";
    }

    
    public Thread newThread(Runnable r) {
        Thread t = new Thread(group, r,
                              namePrefix + threadNumber.getAndIncrement(),
                              0);
        if (t.isDaemon())
            // è®¾ç½®ä¸ºéå®ˆæŠ¤çº¿ç¨‹
            t.setDaemon(false);
        if (t.getPriority() != Thread.NORM_PRIORITY)
            // è®¾ç½®ä¼˜å…ˆçº§ä¸ºé»˜è®¤
            t.setPriority(Thread.NORM_PRIORITY);
        return t;
    }
}
```



### RejectedExecutionHandler

RejectedExecutionHandlerï¼šæ‹’ç»ç­–ç•¥

å½“çº¿ç¨‹æ•°é‡ > maximumPoolSizeæ—¶ï¼Œçº¿ç¨‹æ± å­˜ä¸ä¸‹äº†ï¼Œå°±éœ€è¦ä¸€ç§æ‹’ç»ç­–ç•¥å¤„ç†ã€‚



å››ç§æ‹’ç»ç­–ç•¥ ï¼š

1. ThreadPoolExecutor.AbortPolicyï¼šä¸¢å¼ƒä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚**é»˜è®¤æ‹’ç»å¤„ç†ç­–ç•¥**ï¼Œ
2. ThreadPoolExecutor.DiscardPolicyï¼šä¸¢å¼ƒæ–°æ¥çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸
3. ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒæœ€æ—©çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œç¨‹åºï¼ˆå¦‚æœå†æ¬¡å¤±è´¥ï¼Œé‡å¤æ­¤è¿‡ç¨‹ï¼‰
4. ThreadPoolExecutor.CallerRunsPolicyï¼šç”±è°ƒç”¨çš„çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ï¼Œå³è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹æ¥æ‰§è¡Œ



æ³¨ï¼šThreadPoolExecutor.CallerRunsPolicyå­˜åœ¨ä¸€ä¸ªé£é™©ï¼šä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯¼è‡´çº¿ä¸ŠOOMã€‚

å½“ç„¶å¦‚æœä¸šåŠ¡é‡æ²¡é‚£ä¹ˆé«˜è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œèƒ½å¤Ÿä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚

å¦‚æœä¸äº†è§£çº¿ç¨‹ä¸šåŠ¡é‡ï¼Œå»ºè®®ä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼Œå³AbortPolicyä¸¢å¤±å¹¶æŠ›å¼‚å¸¸ã€‚



æ‹’ç»ç­–ç•¥ä¸æ­¢å››ç§ï¼Œä¸Šé¢åªæ˜¯æä¾›çš„æ‹’ç»ç­–ç•¥ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼Œåªéœ€å®ç°RejectedExecutionHandlerå³å¯ã€‚

ä¾‹å¦‚ï¼šå°†æ¶ˆæ¯ä¿å­˜ä¸‹æ¥ã€‚

```java
public class SavePolicy implements RejectedExecutionHandler {

    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // send to mq
    }
}
```



### å°ç»“

çº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€éæ ¸å¿ƒçº¿ç¨‹æ•°å­˜æ´»æ—¶é—´åŠå…¶å•ä½ã€é˜»å¡é˜Ÿåˆ—ï¼Œè¿™äº”ä¸ªå‚æ•°æ˜¯å¿…é¡»è‡ªå®šä¹‰çš„ï¼Œæ˜¯éå¸¸é‡è¦çš„å‚æ•°ã€‚

å¯¹äºåˆ›å»ºçº¿ç¨‹å·¥å‚ä¸æ‹’ç»ç­–ç•¥ä¸æ˜¯å¿…é¡»è‡ªå®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é»˜è®¤çš„è®¾ç½®ã€‚



çº¿ç¨‹æ± çš„æµç¨‹å¦‚ä¸‹å›¾ï¼š

![çº¿ç¨‹æ± .png](images/çº¿ç¨‹æ± .png)





## Executorå’ŒExecutors

åœ¨JDKæºç ä¸­ï¼Œæœ‰ä¸€ä¸ªå‘½åä¹ æƒ¯ï¼Œå¦‚æ•°ç»„çš„å·¥å…·ç±»å«Arraysï¼Œå®¹å™¨çš„å·¥å…·ç±»å«Collections

Executoræ˜¯çº¿ç¨‹æ± çš„é¡¶çº§æ¥å£ï¼Œçº¿ç¨‹æ± çš„å·¥å…·ç±»å°±å«åšï¼šExecutorsï¼Œä¹Ÿå«çº¿ç¨‹æ± çš„å·¥å‚



## å››ç§å¸¸è§çº¿ç¨‹æ± 



### newSingleThreadExecutor

singleThreadï¼šå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼ˆä¸ºä»€ä¹ˆéœ€è¦å•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Ÿå› ä¸ºçº¿ç¨‹æ± æœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶ä¸”å¯ä»¥ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼‰

```java
public static ExecutorService newSingleThreadExecutor() {
    return new FinalizableDelegatedExecutorService
        (new ThreadPoolExecutor(1, 1,
                                0L, TimeUnit.MILLISECONDS,
                                new LinkedBlockingQueue<Runnable>()));
}
```

æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œèƒ½å¤Ÿä¿è¯ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚å¦‚æœå”¯ä¸€çš„çº¿ç¨‹ä¸ç©ºé—²ï¼Œåˆ™è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚

ç”¨é€”ï¼šä¿è¯ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œ



### newCachedThreadPool

Cachedï¼šç¼“å­˜çš„æ„æ€ï¼Œé‡åœ¨å¤ç”¨ã€‚

```java
public static ExecutorService newCachedThreadPool() {
    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                  60L, TimeUnit.SECONDS,
                                  new SynchronousQueue<Runnable>());
}
```

æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹0ã€‚å½“éœ€è¦æ‰§è¡Œå¾ˆå¤š**çŸ­æ—¶é—´**çš„ä»»åŠ¡æ—¶ï¼ŒCacheThreadPoolçš„çº¿ç¨‹å¤ç”¨ç‡æ¯”è¾ƒé«˜ï¼Œè€Œä¸”çº¿ç¨‹60såä¼šå›æ”¶ï¼Œæ„å‘³ç€å³ä½¿æ²¡æœ‰ä»»åŠ¡è¿›æ¥ï¼Œä¹Ÿä¸ä¼šå ç”¨å¾ˆå¤šèµ„æºã€‚

ç”¨é€”ï¼šæ‰§è¡Œå¾ˆå¤šçŸ­æ—¶é—´çš„ä»»åŠ¡



### newFixedThreadPool

fixedï¼šå›ºå®šçš„

```java
public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) {
    return new FinalizableDelegatedExecutorService
        (new ThreadPoolExecutor(1, 1,
                                0L, TimeUnit.MILLISECONDS,
                                new LinkedBlockingQueue<Runnable>(),
                                threadFactory));
}
```

æ ¸å¿ƒçº¿ç¨‹=æœ€å¤§çº¿ç¨‹æ•°ï¼Œå› æ­¤æ— éæ ¸å¿ƒçº¿ç¨‹ã€‚ä»»åŠ¡é˜Ÿåˆ—ç”¨çš„æ˜¯LinkedBlockingQueueï¼Œé»˜è®¤å¤§å°æ˜¯Integer.MAX_VALUE

ç”¨é€”ï¼šæ‰§è¡Œä»»åŠ¡é‡æ¯”è¾ƒå¹³ç¼“



#### newFixedThreadPoolä¸CachedThreadPoolå¯¹æ¯”

- ä»»åŠ¡é‡æ¯”è¾ƒå¹³ç¼“ç”¨FixedThreadPool
- ä»»åŠ¡é‡å¿½é«˜å¿½ä½ï¼Œç”¨CacheThreadPool

æ³¨ï¼šä¸€èˆ¬æˆ‘ä»¬éƒ½ä¸ç”¨ï¼Œè€Œæ˜¯æ ¹æ®éœ€è¦è‡ªå®šä¹‰



### newScheduledThreadPool

Scheduledï¼šå®šæ—¶

```java
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
          new DelayedWorkQueue());
}
```

ç”¨é€”ï¼šå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± 

ç¤ºä¾‹ï¼š

```java
public class SchedulePoolDemo {

    public static void main(String[] args) {
        ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(5);
        // initialDelay: åˆå§‹å»¶è¿Ÿæ—¶é—´
        // period: å‘¨æœŸ
        // 2ç§’æ‰§è¡Œä¸€æ¬¡
        executor.scheduleAtFixedRate(() ->{
            System.out.println("***2ç§’æ‰§è¡Œä¸€æ¬¡****");
        },0,2, TimeUnit.SECONDS);
    }
}
```

é¢è¯•é¢˜ï¼šå‡å¦‚æä¾›ä¸€ä¸ªé—¹é’ŸæœåŠ¡ï¼Œè®¢é˜…çš„äººå¾ˆå¤šï¼Œ10äº¿äººï¼Œæ€ä¹ˆä¼˜åŒ–ï¼Ÿ



## çº¿ç¨‹æ± å¤§å°çš„é€‰æ‹©

å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œæœ€ç»ˆä¼šç«äº‰ç¨€ç¼ºçš„CPUå’Œå†…å­˜ï¼Œæµªè´¹å¤§é‡çš„æ—¶é—´åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¿‡å°‘ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨ã€‚

Brian Goetzå»ºè®®ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼ä¼°ç®—ï¼š

> N(thread) = N(cpu) * U(cpu) * (1+W/C)
>
> N(cpu)ï¼šæœºå™¨å¤šå°‘CPU
>
> U(cpu)ï¼šæœŸæœ›çš„CPUåˆ©ç”¨ç‡
>
> W/Cï¼šç­‰å¾…æ—¶é—´ï¼ˆwaitï¼‰ä¸è®¡ç®—æ—¶é—´ï¼ˆcomputationï¼‰çš„æ¯”ç‡

æœ€ç»ˆè¿˜æ˜¯ä»¥å‹åŠ›æµ‹è¯•ä¸ºå‡†



æŸ¥çœ‹æœºå™¨çº¿ç¨‹æ•°ï¼Œå½“ç„¶æˆ‘ä»¬ä¸€èˆ¬å¯ä»¥ç”¨topå‘½ä»¤æŸ¥çœ‹ï¼Œtopæ¥ç€æŒ‰1

```java
public static void main(String[] args) {
    System.out.println(Runtime.getRuntime().availableProcessors());
}
```

8æ ¸æœºå™¨ç¤ºä¾‹è®¾ç½®ï¼š

```java
private static final ThreadPoolExecutor EXECUTOR = new ThreadPoolExecutor(5, 10, 10L, TimeUnit.MINUTES,
            new LinkedBlockingQueue<>(50), new MonitorThreadFactory(), new ThreadPoolExecutor.AbortPolicy());
```



## çº¿ç¨‹æ± ä¸»è¦çš„ä»»åŠ¡å¤„ç†æµç¨‹

1. çº¿ç¨‹æ€»æ•°é‡ < corePoolSizeï¼Œæ— è®ºçº¿ç¨‹æ˜¯å¦ç©ºé—²ï¼Œéƒ½ä¼šæ–°å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ˆè®©æ ¸å¿ƒçº¿ç¨‹æ•°é‡å¿«é€Ÿè¾¾åˆ°corePoolSizeï¼Œåœ¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡ < corePoolSizeæ—¶ï¼‰ã€‚**æ³¨æ„ï¼Œè¿™ä¸€æ­¥éœ€è¦è·å¾—å…¨å±€é”ã€‚**
2. çº¿ç¨‹æ€»æ•°é‡ >= corePoolSizeæ—¶ï¼Œæ–°æ¥çš„çº¿ç¨‹ä»»åŠ¡ä¼šè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç„¶åç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹ä¼šä¾æ¬¡å»ç¼“å­˜é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ¥æ‰§è¡Œï¼ˆä½“ç°äº†**çº¿ç¨‹å¤ç”¨**ï¼‰ã€‚
3. å½“ç¼“å­˜é˜Ÿåˆ—æ»¡äº†ï¼Œè¯´æ˜è¿™ä¸ªæ—¶å€™ä»»åŠ¡å·²ç»å¤šåˆ°çˆ†æ£šï¼Œéœ€è¦ä¸€äº›â€œä¸´æ—¶å·¥â€æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡äº†ã€‚äºæ˜¯ä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚**æ³¨æ„ï¼Œè¿™ä¸€æ­¥éœ€è¦è·å¾—å…¨å±€é”ã€‚**
4. ç¼“å­˜é˜Ÿåˆ—æ»¡äº†ï¼Œ ä¸”æ€»çº¿ç¨‹æ•°è¾¾åˆ°äº†maximumPoolSizeï¼Œåˆ™ä¼šé‡‡å–ä¸Šé¢æåˆ°çš„æ‹’ç»ç­–ç•¥è¿›è¡Œå¤„ç†ã€‚
5. ![image.png](H:/akane-note/ğŸ°ç¼–ç¨‹è¯­è¨€/å¤šçº¿ç¨‹/images/java38.png)



## ThreadPoolExecutoræºç åˆ†æ



å‚æ•°

+1

+1

count ++ addworkder start







## ForkJoinPool





### ä»€ä¹ˆæ˜¯Fork/Join

Fork/Joinæ¡†æ¶æ˜¯ä¸€ä¸ªå®ç°äº†ExecutorServiceæ¥å£çš„å¤šçº¿ç¨‹å¤„ç†å™¨ï¼Œå®ƒä¸“ä¸ºé‚£äº›å¯ä»¥é€šè¿‡é€’å½’åˆ†è§£æˆæ›´ç»†å°çš„ä»»åŠ¡è€Œè®¾è®¡ï¼Œæœ€å¤§åŒ–çš„åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æ¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚

ä¸å…¶ä»–ExecutorServiceç›¸å…³çš„å®ç°ç›¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚è€Œä¸ä¹‹ä¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä½¿ç”¨äº†**å·¥ä½œçªƒå–ç®—æ³•**



forkï¼šåˆ†å‰

joinï¼šæ±‡æ€»

åˆ†è€Œæ²»ä¹‹ã€‚forkå°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†è§£æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œè€Œjoinå°†å„ä¸ªå°ä»»åŠ¡æ±‡æ€»èµ·æ¥ï¼Œå¾—åˆ°å¤§ä»»åŠ¡çš„ç»“æœã€‚

```
RecursiveTask
ForkJoinTask
```



Fork/Joinè¿è¡Œæµç¨‹ï¼š

![image.png](images/java40.png)

### ç‰¹æ®Šçš„çº¿ç¨‹æ± newWorkStealingPool

å·¥ä½œçªƒå–çº¿ç¨‹æ± 

å¯¹ForkJoinPoolçš„å°è£…

```
public static ExecutorService newWorkStealingPool() {
    return new ForkJoinPool
        (Runtime.getRuntime().availableProcessors(),
         ForkJoinPool.defaultForkJoinWorkerThreadFactory,
         null, true);
}
```

ç¤ºä¾‹ï¼š

```java
public class WorkStealingPoolDemo {
    public static void main(String[] args) throws IOException {
        ExecutorService service = Executors.newWorkStealingPool();
        System.out.println("CPUæ ¸æ•°: " + Runtime.getRuntime().availableProcessors());

        service.execute(new R(1000));
        service.execute(new R(2000));
        service.execute(new R(2000));
        service.execute(new R(2000)); //daemon
        service.execute(new R(2000));

        //ç”±äºäº§ç”Ÿçš„æ˜¯ç²¾çµçº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ã€åå°çº¿ç¨‹ï¼‰ï¼Œä¸»çº¿ç¨‹ä¸é˜»å¡çš„è¯ï¼Œçœ‹ä¸åˆ°è¾“å‡º
        System.in.read();
    }

    static class R implements Runnable {
        int time;
        R(int t) {
            this.time = t;
        }

        @Override
        public void run() {
            try {
                TimeUnit.MILLISECONDS.sleep(time);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(time  + " " + Thread.currentThread().getName());
        }
    }
}
```

ç»“æœï¼š

çº¿ç¨‹2æ‰§è¡Œä¸€æ¬¡åï¼Œçªƒå–äº†æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ‰§è¡Œäº†ä¸¤æ¬¡

```
CPUæ ¸æ•°: 4
1000 ForkJoinPool-1-worker-2
2000 ForkJoinPool-1-worker-1
2000 ForkJoinPool-1-worker-3
2000 ForkJoinPool-1-worker-0
2000 ForkJoinPool-1-worker-2
```





### 18.2 å·¥ä½œçªƒå–ç®—æ³•

å·¥ä½œçªƒå–ç®—æ³•æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹æ‰§è¡Œä¸åŒä»»åŠ¡é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­ï¼ŒæŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡åä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚

å·¥ä½œçªƒå–æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image.png](images/java41.png)



å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çªƒå–å¦ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å‡å°‘ä¸¤ä¸ªä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨**åŒç«¯é˜Ÿåˆ—**æ¥å­˜å‚¨ä»»åŠ¡ã€‚è¢«çªƒå–çš„ä»»åŠ¡çº¿ç¨‹éƒ½ä»åŒç«¯é˜Ÿåˆ—çš„**å¤´éƒ¨**æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–å…¶ä»–ä»»åŠ¡çš„çº¿ç¨‹ä»åŒç«¯é˜Ÿåˆ—çš„**å°¾éƒ¨**æ‰§è¡Œä»»åŠ¡ã€‚

å¦å¤–ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨çªƒå–ä»»åŠ¡æ—¶è¦æ˜¯æ²¡æœ‰å…¶ä»–å¯ç”¨çš„ä»»åŠ¡äº†ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¿›å…¥**é˜»å¡çŠ¶æ€**ä»¥ç­‰å¾…å†æ¬¡â€œå·¥ä½œâ€ã€‚

![image.png](images/java42.png)



```
ExecutorService newWorkStealingPool()
```





RecursiveAction é€’å½’ ï¼Œä¸å¸¦è¿”å›å€¼çš„





ParalleStreamAPI

åŸç†ï¼šfork join pool





